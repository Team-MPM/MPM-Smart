@using ApiSchema.DeviceOptions
@using ApiSchema.Usermanagement
@using Frontend.Services
@inject ApiAccessor accessor


<MudDialog>
    <TitleContent>
        Edit User
    </TitleContent>

    <DialogContent>
        <MudContainer Class="d-flex flex-column">
            <MudPaper Class="pa-3 ma-2">
                @if (User.CanChangeUsername)
                {
                    <MudTextField T="string" @bind-Value="@User.Username" Label="Username" Variant="Variant.Filled">@User.Username</MudTextField>
                }
                else
                {
                    <MudTextField T="string" disabled @bind-Value="@User.Username" Label="Username" Variant="Variant.Filled">@User.Username</MudTextField>
                }
            </MudPaper>
            @if (User.Username != "admin" && User.Username != "Visitor")
            {
                <MudPaper Class="pa-3 ma-2">
                    <MudCheckBox Label="Can change Username" @bind-Value="@User.CanChangeUsername"></MudCheckBox>
                </MudPaper>
            }

            <MudPaper Class="pa-3 ma-2">
                <MudCheckBox Label="Change Password For User" @bind-Value="@ChangePassword"/>
                @if (ChangePassword)
                {
                    <MudTextField T="string" Label="New Password" @bind-Value="@NewPassword"/>
                }
            </MudPaper>

            @if (User.Username != "admin")
            {
                <MudPaper Class="pa-3 ma-2">
                    <MudCheckBox Label="Is active" @bind-Value="@User.IsActive"></MudCheckBox>
                </MudPaper>
            }

            <MudPaper Class="pa-3 ma-2">
                <MudStack>
                    <MudSelect T="string" Label="Sprache" @bind-Value="@User.Language">
                        @foreach(var language in m_Languages)
                        {
                            <MudSelectItem T="string" Value="language">@language</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            </MudPaper>

            <MudPaper Class="pa-3 ma-2">
                <MudCheckBox Label="Use dark Mode" @bind-Value="@User.UseDarkMode"></MudCheckBox>
            </MudPaper>

            <MudPaper>
                <MudText Color="Color.Error">@ErrorMessage</MudText>
            </MudPaper>

            @if (User.Username != "admin")
            {
                <MudPaper Class="pa-3 ma-2">
                    <MudText Typo="Typo.h5">Permissions:</MudText>
                    @foreach (var kvp in AllPermissions)
                    {
                        <MudText Class="pa-2 ma-2" Typo="Typo.h6">@kvp.Key</MudText>
                        foreach (var permission in kvp.Value)
                        {
                            <MudPaper Class="d-flex flex-wrap">
                                <MudCheckBox Label="@permission" Value="@IsPermissionSet[permission]"
                                             Disabled="@CheckIfDisabled(permission)"
                                             ValueChanged="@((bool b) => ApplyExtraPermissions(b, permission))"></MudCheckBox>
                            </MudPaper>
                        }
                    }
                </MudPaper>
            }
        </MudContainer>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance? MudDialog { get; set; }
    [Parameter] public DeviceOptions DeviceOptions { get; set; }
    [Parameter] public UsersModel User { get; set; }
    private Dictionary<string, List<string>> AllPermissions { get; set; } = new Dictionary<string, List<string>>();
    private string m_OldUsername = "";
    private readonly List<string> m_Languages = new List<string> { "Deutsch", "English", "Polish" };
    private string ErrorMessage = "";
    private Dictionary<string, bool> IsPermissionSet { get; set; } = new Dictionary<string, bool>();
    private bool ChangePassword { get; set; }
    private string NewPassword { get; set; }

    protected override async Task OnInitializedAsync()
    {
        m_OldUsername = User.Username;
        var result = await accessor.GetAllPermissions();
        if(result.Success)
            AllPermissions = result.Response!;
        AllPermissions.SelectMany(s => s.Value).ToList().ForEach(p => IsPermissionSet.Add(p, User.Permissions.Contains(p)));
    }

    private string RemovePrefix(string permission) => permission.Replace("Permissions.", "");

    private async Task Submit()
    {
        if (ChangePassword)
        {
            var resultPw = await accessor.SetPasswordForUser(User.Username, NewPassword);
            if (!resultPw.Success)
            {
                ErrorMessage = resultPw.Message!;
                Console.WriteLine(ErrorMessage);
                await InvokeAsync(StateHasChanged);
                return;
            }
        }
        User.Permissions = IsPermissionSet.Where(p => p.Value).Select(p => p.Key).ToList();
        var result = await accessor.UpdateUser(m_OldUsername, User);
        if (!result.Success)
        {
            if(ErrorMessage != "")
                ErrorMessage += ", ";
            ErrorMessage = result.Message!;
            Console.WriteLine(ErrorMessage);
            await InvokeAsync(StateHasChanged);
            return;
        }
        await accessor.UpdateUser(m_OldUsername, User);
        MudDialog.Close(DialogResult.Ok(User));
    }

    public void ApplyExtraPermissions(bool isChecked, string permission)
    {
        var permissionParts = permission.Split('.');
        var permissionsToCheck = new List<string>();
        AllPermissions.SelectMany(kvp => kvp.Value).ToList()
            .ForEach(s => permissionsToCheck.Add(s));

        if (!permission.Contains('*'))
        {
            IsPermissionSet[permission] = isChecked;
        }

        for (int i = 0; i < permissionParts.Length; i++)
        {
            if (permissionParts[i] == "*")
            {
                permissionsToCheck.ForEach(p => IsPermissionSet[p] = isChecked);
                return;
            }
            permissionsToCheck =  permissionsToCheck.Where(p => p.Contains(permission.Replace(".*", ""))).ToList();
        }

        InvokeAsync(StateHasChanged);
    }

    public bool CheckIfDisabled(string permission)
    {
        string? highest = GetHighestJokerPermission(permission.Split('.').Length, permission);
        if (string.IsNullOrEmpty(highest))
            return false;
        if (highest == permission)
            return false;
        if (permission.Contains(highest.Replace(".*", "").Replace("*", "")))
            return true;
        return false;
    }

    public string? GetHighestJokerPermission(int permissionsLength, string permissionType)
    {
        if (!(permissionType.EndsWith(".*") || permissionType.EndsWith("*")))
        {
            var splittedPermission = permissionType.Split(".").ToList();
                splittedPermission.RemoveAt(splittedPermission.Count - 1);
            permissionType = string.Join(".", splittedPermission);
        }

        List<string> highest = IsPermissionSet.Where(s => s.Value)
            .Select(s => s.Key)
            .Where(s => s.Contains('*'))
            .Where(s => s.Replace(".*", "").Split('.').Length <= permissionsLength)
            .Where(s => s.Split('.').First() == permissionType.Split('.').First() || s.Split('.').First() == "*")
            .OrderBy(p => p.Split('.').Length)
            .ThenBy(p => p.Length)
            .ToList();

        if(highest.Count <= 1)
            return highest.FirstOrDefault();
        if(highest.Any(s => s.Split(".").Length < permissionsLength))
            return highest.FirstOrDefault(s => s.Split(".").Length < permissionsLength);
        return highest.FirstOrDefault(s => s.Contains(permissionType));
    }


    private void Cancel()
    {
        MudDialog.Cancel();
    }
}